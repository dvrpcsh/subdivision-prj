# ===================================================================
# GitHub Actions ì›Œí¬í”Œë¡œìš°: Spring Boot ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ í‘¸ì‹œ
# ===================================================================
name: Java CI/CD with Gradle and Docker

# 1. ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì • (ì´ì „ê³¼ ë™ì¼)
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

# 2. ì‹¤í–‰ë  ì‘ì—…(Job) ì •ì˜
jobs:
  build-and-push-image: # ì‘ì—… ì´ë¦„ì„ ë” ëª…í™•í•˜ê²Œ ë³€ê²½
    runs-on: ubuntu-latest

    # 3. ì‘ì—…ì˜ ì‹¤í–‰ ë‹¨ê³„ (Steps) ì •ì˜
    steps:
      # 3-1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì´ì „ê³¼ ë™ì¼)
      - uses: actions/checkout@v4

      # 3-2. JDK 17 ì„¤ì¹˜ (ì´ì „ê³¼ ë™ì¼)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3-3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (ì´ì „ê³¼ ë™ì¼)
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 3-4. Gradleë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ (ì´ì „ê³¼ ë™ì¼)
      - name: Build with Gradle
        run: ./gradlew build -x test

      # ğŸ’¡ [CD ë‹¨ê³„ ì¶”ê°€] 3-5. Docker Hubì— ë¡œê·¸ì¸
      # GitHub Secretsì— ì €ì¥ëœ Docker Hub ì‚¬ìš©ì ì´ë¦„ê³¼ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
      # ì´ë ‡ê²Œ í•˜ë©´ ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ê°€ ì½”ë“œì— ë…¸ì¶œë˜ì§€ ì•Šì•„ ì•ˆì „í•©ë‹ˆë‹¤.
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ğŸ’¡ [CD ë‹¨ê³„ ì¶”ê°€] 3-6. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # 'docker/build-push-action'ì„ ì‚¬ìš©í•˜ì—¬ Dockerfileë¡œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³ ,
      # Docker Hub ì €ì¥ì†Œì— ìë™ìœ¼ë¡œ í‘¸ì‹œ(ì—…ë¡œë“œ)í•©ë‹ˆë‹¤.
      # íƒœê·¸(tag)ëŠ” Docker Hub ì‚¬ìš©ì ì´ë¦„ê³¼ í”„ë¡œì íŠ¸ ì´ë¦„ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/subdivision-prj:latest

